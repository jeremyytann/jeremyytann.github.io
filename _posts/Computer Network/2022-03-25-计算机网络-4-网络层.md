---
title: 计算机网络 4 — 网络层
date: 2022-03-25 16:36:00 +0800
categories: [Notes, Computer Network]
tags: [Computer Network]
img_path: /assets/img/ComputerNetwork/CN-4
katex: true
---

## **网络层提供的两种服务**

网络层应该向运输层提供这样的服务，曾**引起了长期的争论**。争论焦点的实质是：**数据的可靠传输应该由网络还是端系统来负责？**



### **面向连接**

面向连接的服务，即虚电路 (virtual circuit)。虚电路**只是一种逻辑连接，分组沿着这条逻辑连接按照存储转发方式传送，而非真正建立一条物理连接**。在两台计算机进行通信时，**先由网络建立连接，之后的数据均通过该连接进行，由网络保证数据传输的可靠性**。其支持方以电信公司为代表。



### **无连接**

无连接的服务，即数据报 (datagram)。网络**在发送数据时，不需要先建立连接，每个分组在网络中独立传送，与其前后的分组无关**。**网络层不保证服务质量**，分组可能出错、丢失、重复和失序，也不保证分组传送的时限。其支持方以 Internet 为代表，TCP/IP 就是采用数据报服务。



## **网际协议 IP**

网际协议 IP 是 TCP/IP 体系中两个最重要的协议之一。与 IP 协议配套使用的还有四个协议：

- 地址解析协议 (Address Resolution Protocol, ARP)
- 逆地址解析协议 (Reverse Address Resolution Protocol, RARP)，已淘汰不使用了
- 网际控制报文协议 (Internet Control Message Protocol, ICMP)
- 网际组管理协议 (Internet Group Management Protocol, IGMP)

 

### **分类的 IP 地址**

IP 地址是给连接到互联网上的每一台主机的每一个接口，分配一个在**全世界范围内是唯一的 32 位标识符**。IP 地址现在由互联网名字和数字分配机构 (Internet Corporation for Assigned Names and Numbers, ICANN) 进行分配。

![](IPType.png){: style="border-radius: 5%"}

IP 地址被**分为 A, B, C, D, E 五类**，每一类地址都**包含网络号以及主机号两个字段**。其表示方法为点分十进制记法 (dotted decimal notation)。

B 类地址中的网络地址 128.0.0.0 和 C 类地址中的网络地址 192.0.0.0 都是规定不指派的。其中还有一些有特殊含义的 IP 地址，像是**全 0 表示本网络或本主机的 IP 地址、全 1 表示广播地址的 IP 地址以及网路号为 127 用于本地软件环回测试的 IP 地址**。



### **IP 地址与硬件地址**

`物理地址`

**数据链路层和物理层使用的地址**，被**存放在数据链路层的帧中**。

`IP 地址`

**网络层和以上各层使用的地址**，是一种**逻辑地址**，被**存放在 IP 包头部**。



### **ARP 与 RARP 协议**

`ARP协议 (Address Resolution Protocol)`

全称为 RFC 826: An Ethernet Address Resolution Protocol。

每一台主机都设有一个 **ARP 高速缓存 (ARP cache)**，里面**有本局域网上的各主机和路由器的 IP 地址到硬件地址的映射表**。ARP **解决同一局域网中的主机或路由器的 IP 地址和硬件地址的映射问题**。如果目的主机不在本局域网内，IP 包就需要经由路由器转发。此时在局域网内要完成的是路由器 IP 与物理地址的映射。

`RARP协议 (Reversed Address Resolution Protocol)`

旧协议，作用是**使只知道自己硬件地址的主机能够通过 RARP 协议找出其 IP 地址。**现在的 DHCP 协议已经包含了 RARP 协议的功能。



### **IP 数据报格式**

`版本 Version`

4bit，IP 协议的版本，目前的 IP 协议版本号为 4，即 IPv4。

`首部长度 IHL`

4bit，IP 包头长度，最小 5，最大 15，单位为 word (32bit)。

`区分服务 Type of Service`

1字节，服务类型，目前**很多路由器忽略该字段**。

`总长度 Total Length`

2字节，**IP包总长度，包含头部和数据**，单位为字节。

`标识 Identification`

2字节，是一个计数器，**用以产生 IP 包的标识**。当一个 IP 包超过数据链路层 MTU 时，就需要分片传输。**分片的多个包具有相同的标识，便于接收端重组**。

`标志 Flag`

3bit，目前只使用两个Flag，分别是：

- 1bit, **Don't Fragment, DF**。当 DF = 0 时允许分片。
- 1bit, **More Fragment, MF**。当 MF = 1 时表示后面还有分片，而 MF = 0 则表示最后一片。

`片偏移 Fragment Offset`

13bit，片偏移，较长的**包在分片后，某片在原分组中的相对位置**，以 8 字节为单位。

`生存时间 Time To Live`

1字节，生存时间，**IP 包在网络中可通过的路由器个数的最大值**。IP 包每经过一个路由器则 TTL 减 1，TTL 为 0 时就丢弃，并向源主机发送一个告警包。Windows 操作系统一般为 128，UNIX 操作系统一般为 255，Linux 一般为 64。

`协议 Protocol`

8bit，协议字段，指出**此数据报携带的数据是使用什么协议**，以便使目的主机的 IP 层知道应该将数据部分上交给哪个协议进行处理。

`首部校验和 Header checksum`

2字节，只**检验数据报的首部**，不包括数据部分。

`源地址 Source address`

4字节，源 IP 地址。

`目标地址 Destination address`   

4字节，目的 IP 地址。



### **校验和算法**

**对 IP 包头**，每 16 位求反，循环相加，和再求反。若结果为 0 则保留。否则丢弃该数据报。



## **划分子网和构造超网**

由于 ARPANET 早期，**IP 地址的设计不够合理**。

1. 分类 IP 地址无法适应 Internet 快速发展的需要，每个 A 类地址的主机数超过 1000 万，B 类地址也超过 6 万。有的单位申请了一个 B 类地址网络，连接的主机数却不多，导致 **IP 地址空间的利用率有时很低**，造成 IP 地址的浪费，还会使得 IP 地址空间的资源过早被用完。
2. 为**每一个物理网络分配一个网络号会使路由表变得太大**，因而使网络性能变坏。
3. **两级 IP 地址不够灵活**。有些情况下，一个单位需要在新的地点马上开通一个新的网络。但在申请到一个新的 IP 地址之前，新增加的网络是不可能连接到互联网上工作的。而我们希望的是，一个单位能随时灵活的增加本单位的网络，不必事先到互联网管理机构去申请新的网络号。这是两级 IP 地址无法做到的。

为了解决上述问题，就在 **IP 地址中增加了一个子网号字段**，使**两级 IP 地址变为三级 IP 地址**，就能较好地解决上述问题，使用起来也更灵活。而这就是**划分子网**。



### **划分子网**

`基本思想`

一个拥有多个物理网络的单位可按照物理网络划分为若干个子网 (subnet)。**划分子网的方法是从网络的主机号借用若干位作为子网号 (subnet-id)**。因此两级 IP 地址在本单位内部就变为了三级 IP 地址。

- 原来的 IP 地址 ::= 网络号，主机号
- 变为了 IP 地址 ::= 网络号，子网号，主机号

其他网络发来的 IP 数据报，仍然根据 IP 数据报的目的网络号 net-id，找到本网络的路由器。此路由器收到 IP 数据报后，再按照目的网络号 net-id 和子网号 subnet-id 找到目的子网。



### **子网掩码**

从 IP 数据报的首部无法看出源主机或目的主机所连接的网络是否进行了子网的划分，这是因为 32 位的 IP 地址本身以及数据报的首部都没有包含任何有关子网划分的信息。因此就有了子网掩码。

**子网掩码是一个网络或一个子网的重要属性**，在路由寻址中发挥着重要作用。

![](Subnet.png){: style="border-radius: 5%"}

**使用子网掩码的好处**是，不管网络有没有划分子网，**只要把子网掩码和目的 IP 地址进行逐位的与运算，就能立即得出子网网络地址**。



### **使用子网掩码的分组转发过程**

使用子网划分后，**路由表必须包含以下三项基本信息**：**目的网络地址、子网掩码和下一跳地址**。

在划分子网的情况下，**路由器的转发流程**如下：

1. 从收到的分组的首部提取目的 IP 地址 D。
2. 先用与该路由器直接相连各网络的子网掩码与 D 逐位相与，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就间接交付，执行 3。
3. 若路由表中有目的地址为 D 的特定主机路由，则将分组传送给指明的下一跳路由器。否则执行 4。
4. 对路由表中的每一行的子网掩码与 D 逐位相与，若其结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器。否则执行 5。
5. 若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器。否则执行 6。
6. 报告中转发分组出错。

其**核心操作**是将目的 IP 地址与路由表中子网掩码相与，并判断是否与目的网络地址匹配。



`主机发送数据报是判断目的地址是否在本地子网的方法`

``` 
if ((目的地址 & subnet mask) == (主机地址 & subnet mask))
  目的地址在本地子网，直接交付
else
  数据报发往gateway
end if
```

`路由器查找路由表进行表项匹配的过程`

``` 
if ((目的地址 & subnet mask) == 目的网络地址)
  数据包发往该表项的网络出口
end if
```

`在子网内直接交付过程`

``` 
查找 ARP 缓存，是否有目的 IP 地址对应的 MAC 地址

if (目的 MAC 地址在 ARP 缓存中)
  将 IP 数据包封装成帧后，在局域网内向目的 MAC 地址直接发送帧
else
  在子网内广播发送 ARP 请求，目的主机收到请求后返回 ARP 应答，由此得知目的主机 MAC 地址
end if
```



### **无分类编制 CIDR**

全称为Classless Inter-Domain Routing。

其**主要特点**有：

- **消除了传统 A 类、B 类和 C 类地址以及划分子网的概念**。
- 使用各种长度的**网络前缀**，来代替分类地址中过的网络号和子网号。
- IP 地址从三级编址**回到了两级编址**，IP 地址 ::= 网络前缀，主机号
- 使用**斜线记法 (slash notation)**，又称 CIDR 记法，即在 **IP 地址后加一个斜线，后跟网络前缀所占的位数**，如 **128.14.35.7/20 表示该地址的高 20 位是网络前缀**。
- **网络前缀都相同的连续的 IP 地址组成 CIDR 地址块**，如 128.14.32.0/20 表示的 CIDR 地址块就有 $2^{12}$ 个地址，从 128.14.32.0 至 128.14.47.255。

`路由聚合 (route aggregation)`

由于一个 CIDR 地址块中有很多地址，所以在**路由表中就利用 CIDR 地址块来查找目的网络**。这种地址的聚合常称为路由聚合，它**使得路由表中的一个项目可以表示原来传统分类地址的很多个路由**，可以减少路由表中的表项个数，并减少路由器之间交换的路由信息量。路由聚合**也称为构成超网 (supernetting)**，这是**因为 CIDR地址块大多包含多个 C 类地址**。

`地址掩码`

CIDR **不使用子网，但仍使用地址掩码这个名词**。如 /20 的地址掩码为：

11111111 11111111 11110000 00000000。

`最长前缀匹配`

最长前缀匹配**又称为最长匹配或最佳匹配**。

对于**查找路由表时的匹配结果**，**应该从中选择具有最长前缀匹配的路由**。这是因为**网络前缀越长**，其**地址块就越小**，因而**路由就越具体**。



## **国际控制报文协议 ICMP**

全称为 RFC 792 : Internet Control Message Protocol，**主要用于报告出错和测试等控制信息**。

ICMP **位于 IP 层**，ICMP **报文是装在 IP 数据报中**，**作为其中的数据部分传输的**。



### **ICMP 报文的种类**

ICMP 报文的种类有两种，即 **ICMP 差错报告报文和 ICMP 询问报文**。

**差错报告报文有**：

`终点不可达 Destination unreachable`

路由器或主机**无法传输报文时**，向源主机发送此报文。

`源点抑制 Source quench`

路由器或主机**由于拥塞丢弃报文时**，向源主机发送此报文，使其放慢发送速度。

`超时 Time exceeded`

路由器**收到 TTL 字段为 0 的报文时**，向源主机发送此报文。

`参数问题 Parameter problem`

路由器或主机**收到的报文中，头部有非法字段时**，丢弃数据报，并向源主机发送此报文。

`改变路由 Redirect`

路由器向主机发送此报文，**告知路由改变**，主机下次发送数据报给另外的路由器。



**询问报文有**：

`回送请求或回答 Echo request/reply`

用于**测试网络连通性**。

`时间戳请求或回答 Timestamp request/reply`

用于**时间同步**。



### **ICMP 的应用举例**

`分组网间探测 Ping`

全称为 Packet Internet Groper，其**采用 ICMP Echo request/reply 报文**，用以**测试两台主机之间的连通性**。Ping 是应用层直接使用网络层 ICMP 的一个例子，没有通过运输层的 TCP 或 UDP。



`Traceroute / Tracert`

**采用 ICMP 超时报告报文**，用以**测试到另一台主机所经过的路由信息**。其方法是逐个发出 UDP 报文，其 IP 包头中的 TTL 字段分别设为 1, 2, 3, ...，直到到达目的主机。报文路由路径上的路由器会返回 ICMP 超时报文，从该报文即可得知路由器 IP 地址。
